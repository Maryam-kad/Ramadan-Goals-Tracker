<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Ramadan Goals</title>

  <!-- PWA Manifest (inline via JS) -->
  <meta name="theme-color" content="#0d1b2a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Ramadan Goals" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="description" content="Track your Ramadan goals with friends" />

  <!-- Inline manifest -->
  <link rel="manifest" href="manifest.json" />

  <!-- Apple touch icons (inline SVG via data URI) -->
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='40' fill='%230d1b2a'/%3E%3Cpath d='M140 96.79A49 49 0 1 1 91.21 48 38.1 38.1 0 0 0 140 96.79z' fill='%23d4a842'/%3E%3C/svg%3E" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" />

  <style>
    :root {
      --night: #0d1b2a;
      --navy: #1a2d42;
      --card: #162236;
      --gold: #d4a842;
      --gold-light: #f0c96b;
      --gold-dim: #8a6a20;
      --teal: #2a9d8f;
      --rose: #e76f51;
      --text: #f0e6cc;
      --text-dim: #9aacbd;
      --border: rgba(212,168,66,0.2);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    html, body {
      background: var(--night);
      font-family: 'Lato', sans-serif;
      color: var(--text);
      min-height: 100vh;
      overscroll-behavior: none;
    }
    @keyframes twinkle { from { opacity: 0.15; } to { opacity: 0.65; } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes pulse { 0%,100% { box-shadow: 0 4px 20px rgba(212,168,66,0.3); } 50% { box-shadow: 0 4px 32px rgba(212,168,66,0.6); } }

    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: var(--night); }
    ::-webkit-scrollbar-thumb { background: var(--gold-dim); border-radius: 2px; }

    select, input, option { background: var(--night); color: var(--text); font-family: 'Lato', sans-serif; }
    select option { background: var(--navy); }

    #stars { position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden; }
    .star { position: absolute; border-radius: 50%; background: var(--gold-light); }

    #app { position: relative; z-index: 1; max-width: 480px; margin: 0 auto; padding-bottom: 100px; }

    /* HEADER */
    .header {
      background: linear-gradient(180deg, var(--navy) 0%, transparent 100%);
      padding: 48px 20px 20px;
      text-align: center;
      border-bottom: 1px solid var(--border);
      margin-bottom: 16px;
    }
    .header-title {
      display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 4px;
    }
    .header-title h1 {
      font-family: 'Cinzel', serif; color: var(--gold); font-size: 24px;
      font-weight: 700; letter-spacing: 2px;
    }
    .header-subtitle { color: var(--text-dim); font-size: 12px; letter-spacing: 1px; margin-bottom: 16px; }

    /* RING */
    .ring-wrap { position: relative; width: 100px; height: 100px; margin: 0 auto 16px; }
    .ring-wrap svg { transform: rotate(-90deg); }
    .ring-center {
      position: absolute; inset: 0; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
    }
    .ring-pct { font-family: 'Cinzel', serif; color: var(--gold); font-size: 22px; font-weight: 700; }
    .ring-sub { color: var(--text-dim); font-size: 10px; }

    /* NOTIF BANNER */
    .notif-btn {
      background: rgba(212,168,66,0.12); border: 1px solid var(--border);
      border-radius: 8px; padding: 8px 16px; color: var(--gold-light);
      cursor: pointer; font-family: 'Cinzel', serif; font-size: 12px;
      display: inline-flex; align-items: center; gap: 6px;
    }

    /* INSTALL BANNER */
    #install-banner {
      display: none; margin: 0 16px 12px;
      background: linear-gradient(135deg, rgba(212,168,66,0.15), rgba(42,157,143,0.1));
      border: 1px solid var(--border); border-radius: 12px;
      padding: 12px 14px; gap: 10px; align-items: center;
    }
    #install-banner p { font-size: 12px; color: var(--text-dim); flex: 1; line-height: 1.5; }
    #install-banner p strong { color: var(--text); display: block; margin-bottom: 2px; font-family: 'Cinzel', serif; }
    .install-btn {
      background: var(--gold); border: none; border-radius: 8px; padding: 8px 14px;
      color: var(--night); font-family: 'Cinzel', serif; font-size: 12px;
      font-weight: 700; cursor: pointer; white-space: nowrap;
    }
    .install-dismiss {
      background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 18px; padding: 4px;
    }

    /* FILTER TABS */
    .filter-bar { padding: 0 16px 12px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .filter-bar::-webkit-scrollbar { display: none; }
    .filter-inner { display: flex; gap: 8px; width: max-content; }
    .filter-tab {
      padding: 6px 14px; border-radius: 20px; border: 1px solid var(--border);
      background: transparent; color: var(--text-dim); cursor: pointer;
      font-size: 12px; font-family: 'Cinzel', serif; white-space: nowrap;
      transition: all 0.2s;
    }
    .filter-tab.active { border-color: var(--gold); background: rgba(212,168,66,0.12); color: var(--gold); }

    /* FRIEND INPUT */
    .friend-input-wrap { display: flex; gap: 8px; margin: 8px 16px 0; animation: fadeIn 0.2s ease; }
    .friend-input {
      flex: 1; background: var(--card); border: 1px solid var(--border);
      border-radius: 8px; padding: 8px 12px; color: var(--text);
      font-family: 'Lato', sans-serif; font-size: 13px; outline: none;
    }
    .friend-add-btn {
      padding: 8px 14px; border-radius: 8px; border: none;
      background: var(--gold); color: var(--night); cursor: pointer;
      font-family: 'Cinzel', serif; font-size: 12px; font-weight: 700;
    }

    /* TASKS */
    .tasks { padding: 0 16px; display: flex; flex-direction: column; gap: 10px; }
    .empty { text-align: center; padding: 60px 20px; animation: fadeIn 0.4s ease; }
    .empty p { color: var(--text-dim); margin-top: 16px; font-family: 'Cinzel', serif; font-size: 14px; line-height: 1.8; }

    /* TASK CARD */
    .task-card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 12px; padding: 14px 16px;
      display: flex; gap: 12px; align-items: flex-start;
      transition: all 0.3s; animation: fadeIn 0.3s ease;
      position: relative; overflow: hidden;
    }
    .task-card.done { opacity: 0.65; }
    .task-card.overdue { border-color: var(--rose); }
    .task-card.done-glow::before {
      content: ''; position: absolute; inset: 0;
      background: linear-gradient(135deg, rgba(212,168,66,0.06), transparent);
      pointer-events: none;
    }
    .check-btn {
      width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0;
      border: 2px solid var(--border); background: transparent;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; color: var(--night); font-size: 14px; font-weight: 700;
    }
    .check-btn.checked { background: var(--gold); border-color: var(--gold); }
    .task-body { flex: 1; min-width: 0; }
    .task-title {
      font-family: 'Cinzel', serif; font-size: 13px; font-weight: 600;
      color: var(--text); margin-bottom: 4px;
    }
    .task-card.done .task-title { text-decoration: line-through; color: var(--text-dim); }
    .task-meta { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .tag {
      font-size: 10px; padding: 2px 7px; border-radius: 4px;
      background: rgba(212,168,66,0.12); color: var(--gold-light);
    }
    .tag-teal { background: rgba(42,157,143,0.12); color: #5ecdc4; }
    .tag-dim { color: var(--text-dim); font-size: 10px; }
    .task-timer {
      margin-top: 6px; font-size: 11px; color: var(--gold-dim);
    }
    .task-timer.overdue { color: var(--rose); font-weight: 700; }
    .task-streak { margin-top: 8px; }
    .streak-row {
      display: flex; justify-content: space-between;
      font-size: 10px; color: var(--text-dim); margin-bottom: 3px;
    }
    .streak-bar { height: 3px; background: rgba(212,168,66,0.15); border-radius: 2px; }
    .streak-fill { height: 100%; background: var(--gold); border-radius: 2px; transition: width 0.6s; }
    .delete-btn {
      background: none; border: none; color: var(--text-dim);
      cursor: pointer; font-size: 18px; padding: 2px 4px; flex-shrink: 0;
      line-height: 1;
    }

    /* FAB */
    #fab {
      position: fixed; bottom: calc(28px + env(safe-area-inset-bottom));
      right: 20px; width: 62px; height: 62px; border-radius: 50%;
      background: linear-gradient(135deg, var(--gold), var(--gold-dim));
      border: none; cursor: pointer; font-size: 30px; color: var(--night);
      display: flex; align-items: center; justify-content: center;
      animation: pulse 2.5s ease-in-out infinite;
      z-index: 50; transition: transform 0.2s;
    }
    #fab:active { transform: scale(0.93); }

    /* MODAL */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.75);
      z-index: 100; display: flex; align-items: flex-end;
      justify-content: center; padding: 0;
    }
    .modal {
      background: var(--navy); border: 1px solid var(--border);
      border-radius: 20px 20px 0 0;
      padding: 24px 20px calc(24px + env(safe-area-inset-bottom));
      width: 100%; max-width: 480px;
      max-height: 90vh; overflow-y: auto;
      animation: slideUp 0.3s ease;
    }
    .modal-title {
      font-family: 'Cinzel', serif; color: var(--gold); font-size: 18px;
      font-weight: 700; margin-bottom: 20px;
      display: flex; align-items: center; gap: 8px;
    }
    .form-group { margin-bottom: 14px; }
    .form-label {
      font-size: 11px; color: var(--text-dim); margin-bottom: 5px;
      display: block; font-family: 'Cinzel', serif; letter-spacing: 0.5px;
    }
    .form-input {
      width: 100%; background: rgba(13,27,42,0.8); border: 1px solid var(--border);
      border-radius: 8px; padding: 10px 12px; color: var(--text);
      font-family: 'Lato', sans-serif; font-size: 14px; outline: none;
      -webkit-appearance: none; appearance: none;
    }
    .form-input:focus { border-color: rgba(212,168,66,0.5); }
    .modal-actions { display: flex; gap: 10px; margin-top: 8px; }
    .btn-cancel {
      flex: 1; padding: 12px; border-radius: 10px;
      border: 1px solid var(--border); background: transparent;
      color: var(--text-dim); cursor: pointer; font-family: 'Cinzel', serif; font-size: 13px;
    }
    .btn-add {
      flex: 2; padding: 12px; border-radius: 10px; border: none;
      background: linear-gradient(135deg, var(--gold), var(--gold-dim));
      color: var(--night); cursor: pointer; font-family: 'Cinzel', serif;
      font-size: 13px; font-weight: 700;
    }
    .btn-add:active, .btn-cancel:active { opacity: 0.85; }

    /* TOAST */
    #toast {
      position: fixed; bottom: calc(110px + env(safe-area-inset-bottom));
      left: 50%; transform: translateX(-50%);
      background: var(--navy); border: 1px solid var(--gold);
      border-radius: 10px; padding: 10px 18px;
      color: var(--gold-light); font-size: 13px;
      font-family: 'Cinzel', serif; white-space: nowrap;
      z-index: 200; opacity: 0; transition: opacity 0.3s;
      pointer-events: none;
    }
    #toast.show { opacity: 1; }
  </style>
</head>
<body>

<div id="stars"></div>
<div id="app">
  <div class="header">
    <div class="header-title">
      <svg width="28" height="28" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="#d4a842"/></svg>
      <h1>Ramadan Goals</h1>
    </div>
    <p class="header-subtitle" id="day-label">Loading...</p>
    <div class="ring-wrap">
      <svg width="100" height="100">
        <circle cx="50" cy="50" r="44" fill="none" stroke="rgba(212,168,66,0.12)" stroke-width="8"/>
        <circle id="ring-progress" cx="50" cy="50" r="44" fill="none" stroke="#d4a842"
          stroke-width="8" stroke-linecap="round"
          stroke-dasharray="276.46" stroke-dashoffset="276.46"
          style="transition: stroke-dashoffset 0.8s ease;"/>
      </svg>
      <div class="ring-center">
        <span class="ring-pct" id="ring-pct">0%</span>
        <span class="ring-sub" id="ring-sub">0/0</span>
      </div>
    </div>
    <button class="notif-btn" id="notif-btn" onclick="requestNotif()" style="display:none">
      ğŸ”” Enable Reminders
    </button>
    <div id="notif-granted" style="font-size:11px;color:var(--teal);display:none;margin-top:6px;">
      âœ“ Reminders enabled
    </div>
  </div>

  <!-- Install Banner -->
  <div id="install-banner">
    <p><strong>ğŸ“² Install as App</strong>Get notifications even when the browser is closed</p>
    <button class="install-btn" onclick="installPWA()">Install</button>
    <button class="install-dismiss" onclick="dismissInstall()">Ã—</button>
  </div>

  <!-- Filter Tabs -->
  <div class="filter-bar">
    <div class="filter-inner" id="filter-tabs"></div>
  </div>
  <div id="friend-input-wrap" style="display:none" class="friend-input-wrap">
    <input class="friend-input" id="friend-name-input" placeholder="Friend's name" />
    <button class="friend-add-btn" onclick="confirmAddFriend()">Add</button>
  </div>

  <!-- Tasks -->
  <div class="tasks" id="tasks-list"></div>
</div>

<!-- FAB -->
<button id="fab" onclick="openModal()">+</button>

<!-- Add Task Modal -->
<div class="modal-overlay" id="modal" style="display:none" onclick="closeModalOutside(event)">
  <div class="modal">
    <div class="modal-title">
      <svg width="20" height="20" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="#d4a842"/></svg>
      New Goal
    </div>
    <div class="form-group">
      <label class="form-label">Goal Title *</label>
      <input class="form-input" id="f-title" placeholder="e.g. Read 2 pages of Quran" />
    </div>
    <div class="form-group">
      <label class="form-label">Category</label>
      <select class="form-input" id="f-category">
        <option>Prayer ğŸ•Œ</option>
        <option>Quran ğŸ“–</option>
        <option>Dhikr ğŸ“¿</option>
        <option>Charity ğŸ¤²</option>
        <option>Fasting ğŸŒ™</option>
        <option>Learning ğŸ“š</option>
        <option>Health ğŸ’ª</option>
        <option>Other âœ¨</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Deadline (optional)</label>
      <input class="form-input" id="f-deadline" type="datetime-local" />
    </div>
    <div class="form-group">
      <label class="form-label">Recurring</label>
      <select class="form-input" id="f-recurring">
        <option value="">One-time</option>
        <option value="Daily">Daily</option>
        <option value="Weekly">Weekly</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Assign to</label>
      <select class="form-input" id="f-assignee">
        <option value="">Myself</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-add" onclick="addTask()">Add Goal âœ¨</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<!-- Inline Service Worker via Blob -->
<script>
// â”€â”€â”€ DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let tasks = [];
let friends = [];
let currentFilter = 'All';
let deferredInstallPrompt = null;
let timers = {};

const STORAGE_TASKS = 'ramadan-tasks-v2';
const STORAGE_FRIENDS = 'ramadan-friends-v2';
const RAMADAN_START = new Date('2025-03-01');

// â”€â”€â”€ STORAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function save() {
  localStorage.setItem(STORAGE_TASKS, JSON.stringify(tasks));
  localStorage.setItem(STORAGE_FRIENDS, JSON.stringify(friends));
}

function load() {
  try { tasks = JSON.parse(localStorage.getItem(STORAGE_TASKS)) || []; } catch { tasks = []; }
  try { friends = JSON.parse(localStorage.getItem(STORAGE_FRIENDS)) || []; } catch { friends = []; }
}

// â”€â”€â”€ STARS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initStars() {
  const container = document.getElementById('stars');
  for (let i = 0; i < 70; i++) {
    const s = document.createElement('div');
    s.className = 'star';
    const size = Math.random() * 2 + 0.5;
    s.style.cssText = `
      left:${Math.random()*100}%;top:${Math.random()*100}%;
      width:${size}px;height:${size}px;opacity:${Math.random()*0.4+0.1};
      animation:twinkle ${2+Math.random()*3}s ${Math.random()*3}s ease-in-out infinite alternate;
    `;
    container.appendChild(s);
  }
}

// â”€â”€â”€ RAMADAN DAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateDayLabel() {
  const diff = Math.floor((new Date() - RAMADAN_START) / 86400000) + 1;
  const day = Math.max(1, Math.min(30, diff));
  document.getElementById('day-label').textContent = `Day ${day} of 30 Â· May your deeds be accepted`;
}

// â”€â”€â”€ PROGRESS RING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateRing() {
  const filtered = getFiltered();
  const done = filtered.filter(t => t.done).length;
  const total = filtered.length;
  const pct = total > 0 ? Math.round((done / total) * 100) : 0;
  const circumference = 2 * Math.PI * 44; // 276.46
  const offset = circumference * (1 - pct / 100);
  document.getElementById('ring-progress').style.strokeDashoffset = offset;
  document.getElementById('ring-pct').textContent = pct + '%';
  document.getElementById('ring-sub').textContent = `${done}/${total}`;
}

// â”€â”€â”€ FILTER TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTabs() {
  const tabs = document.getElementById('filter-tabs');
  const all = ['All', 'Myself', ...friends];
  tabs.innerHTML = '';
  all.forEach(name => {
    const btn = document.createElement('button');
    btn.className = 'filter-tab' + (currentFilter === name ? ' active' : '');
    btn.textContent = name === 'All' ? 'ğŸŒ™ All' : `ğŸ‘¤ ${name}`;
    btn.onclick = () => { currentFilter = name; renderTabs(); renderTasks(); };
    tabs.appendChild(btn);
  });
  // Add friend button
  const addBtn = document.createElement('button');
  addBtn.className = 'filter-tab';
  addBtn.textContent = '+ Friend';
  addBtn.style.borderStyle = 'dashed';
  addBtn.onclick = () => {
    const wrap = document.getElementById('friend-input-wrap');
    wrap.style.display = wrap.style.display === 'none' ? 'flex' : 'none';
    if (wrap.style.display !== 'none') document.getElementById('friend-name-input').focus();
  };
  tabs.appendChild(addBtn);
}

function confirmAddFriend() {
  const input = document.getElementById('friend-name-input');
  const name = input.value.trim();
  if (!name) return;
  friends.push(name);
  save();
  input.value = '';
  document.getElementById('friend-input-wrap').style.display = 'none';
  renderTabs();
  updateAssigneeDropdown();
  showToast(`ğŸ‘¤ ${name} added!`);
}

document.getElementById('friend-name-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') confirmAddFriend();
});

// â”€â”€â”€ ASSIGNEE DROPDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateAssigneeDropdown() {
  const sel = document.getElementById('f-assignee');
  sel.innerHTML = '<option value="">Myself</option>';
  friends.forEach(f => {
    const opt = document.createElement('option');
    opt.value = f; opt.textContent = f;
    sel.appendChild(opt);
  });
}

// â”€â”€â”€ GET FILTERED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getFiltered() {
  if (currentFilter === 'All') return tasks;
  if (currentFilter === 'Myself') return tasks.filter(t => !t.assignee);
  return tasks.filter(t => t.assignee === currentFilter);
}

// â”€â”€â”€ RENDER TASKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTasks() {
  // Clear old timers
  Object.values(timers).forEach(clearInterval);
  timers = {};

  const list = document.getElementById('tasks-list');
  const filtered = getFiltered().sort((a, b) => {
    if (a.done !== b.done) return a.done ? 1 : -1;
    if (a.deadline && b.deadline) return new Date(a.deadline) - new Date(b.deadline);
    if (a.deadline) return -1;
    if (b.deadline) return 1;
    return 0;
  });

  if (filtered.length === 0) {
    list.innerHTML = `<div class="empty">
      <svg width="52" height="52" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="#d4a842"/></svg>
      <p>No goals yet.<br/>Every good deed counts this Ramadan.</p>
    </div>`;
    updateRing();
    return;
  }

  list.innerHTML = filtered.map(task => {
    const streakBar = task.recurring && task.streak > 0 ? `
      <div class="task-streak">
        <div class="streak-row">
          <span>ğŸ”¥ ${task.streak}-day streak</span>
          <span>${Math.min(100,Math.round(task.streak/30*100))}% of Ramadan</span>
        </div>
        <div class="streak-bar">
          <div class="streak-fill" style="width:${Math.min(100,task.streak/30*100)}%"></div>
        </div>
      </div>` : '';

    const assigneeTag = task.assignee ? `<span class="tag-dim">ğŸ‘¤ ${task.assignee}</span>` : '';
    const recurTag = task.recurring ? `<span class="tag tag-teal">ğŸ” ${task.recurring}</span>` : '';
    const timerEl = task.deadline ? `<div class="task-timer" id="timer-${task.id}"></div>` : '';

    return `<div class="task-card${task.done?' done':''}${task.done?' done-glow':''}" id="card-${task.id}">
      <button class="check-btn${task.done?' checked':''}" onclick="toggleTask('${task.id}')">${task.done?'âœ“':''}</button>
      <div class="task-body">
        <div class="task-title">${escHtml(task.title)}</div>
        <div class="task-meta">
          <span class="tag">${task.category}</span>
          ${recurTag}${assigneeTag}
        </div>
        ${timerEl}
        ${streakBar}
      </div>
      <button class="delete-btn" onclick="deleteTask('${task.id}')">Ã—</button>
    </div>`;
  }).join('');

  // Start countdown timers
  filtered.forEach(task => {
    if (task.deadline) startTimer(task);
  });

  updateRing();
}

// â”€â”€â”€ TIMER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startTimer(task) {
  const el = document.getElementById(`timer-${task.id}`);
  if (!el) return;
  let notified60 = false;
  let notifiedOverdue = false;

  const tick = () => {
    if (!document.getElementById(`timer-${task.id}`)) {
      clearInterval(timers[task.id]); return;
    }
    const diff = new Date(task.deadline) - new Date();
    if (diff <= 0) {
      el.textContent = `â± Overdue Â· ${formatDate(task.deadline)}`;
      el.className = 'task-timer overdue';
      const card = document.getElementById(`card-${task.id}`);
      if (card && !task.done) card.classList.add('overdue');
      if (!notifiedOverdue && !task.done) {
        notifiedOverdue = true;
        sendNotification(`â° Overdue: ${task.title}`, `Your Ramadan goal deadline has passed!`);
      }
    } else {
      el.className = 'task-timer';
      const h = Math.floor(diff / 3600000);
      const m = Math.floor((diff % 3600000) / 60000);
      const s = Math.floor((diff % 60000) / 1000);
      let label;
      if (h > 24) label = `${Math.floor(h/24)}d ${h%24}h left`;
      else if (h > 0) label = `${h}h ${m}m left`;
      else if (m > 0) label = `${m}m ${s}s left`;
      else label = `${s}s left`;
      el.textContent = `â± ${label} Â· ${formatDate(task.deadline)}`;
      if (diff <= 60000 && !notified60 && !task.done) {
        notified60 = true;
        sendNotification(`â° Almost due: ${task.title}`, `Less than 1 minute remaining!`);
      }
    }
  };
  tick();
  timers[task.id] = setInterval(tick, 1000);
}

function formatDate(iso) {
  return new Date(iso).toLocaleString('en-US', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
}

// â”€â”€â”€ ADD TASK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal() {
  updateAssigneeDropdown();
  document.getElementById('modal').style.display = 'flex';
  document.getElementById('f-title').focus();
}
function closeModal() {
  document.getElementById('modal').style.display = 'none';
  document.getElementById('f-title').value = '';
  document.getElementById('f-deadline').value = '';
  document.getElementById('f-recurring').value = '';
  document.getElementById('f-assignee').value = '';
}
function closeModalOutside(e) {
  if (e.target.id === 'modal') closeModal();
}
function addTask() {
  const title = document.getElementById('f-title').value.trim();
  if (!title) { document.getElementById('f-title').focus(); return; }
  const task = {
    id: Date.now().toString(),
    title,
    category: document.getElementById('f-category').value,
    deadline: document.getElementById('f-deadline').value || '',
    recurring: document.getElementById('f-recurring').value,
    assignee: document.getElementById('f-assignee').value,
    done: false, streak: 0,
    createdAt: new Date().toISOString(),
    doneAt: null,
  };
  tasks.unshift(task);
  save();
  closeModal();
  renderTasks();
  showToast('âœ¨ Goal added!');

  // Schedule background notification if deadline set
  if (task.deadline) scheduleBackgroundNotif(task);
}

function toggleTask(id) {
  const t = tasks.find(t => t.id === id);
  if (!t) return;
  t.done = !t.done;
  t.doneAt = t.done ? new Date().toISOString() : null;
  save();
  renderTasks();
}

function deleteTask(id) {
  tasks = tasks.filter(t => t.id !== id);
  save();
  renderTasks();
  showToast('Task removed');
}

// â”€â”€â”€ DAILY RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkDailyReset() {
  const today = new Date().toDateString();
  let changed = false;
  tasks.forEach(t => {
    if (t.recurring === 'Daily' && t.done) {
      const doneDate = t.doneAt ? new Date(t.doneAt).toDateString() : null;
      if (doneDate !== today) {
        t.done = false;
        t.streak = (t.streak || 0) + 1;
        t.doneAt = null;
        changed = true;
      }
    }
  });
  if (changed) { save(); renderTasks(); }
}

// â”€â”€â”€ NOTIFICATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sendNotification(title, body) {
  if (Notification.permission === 'granted') {
    new Notification(title, { body, icon: 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" rx="12" fill="#0d1b2a"/><path d="M46 34.4A16 16 0 1 1 29.6 18 12.7 12.7 0 0 0 46 34.4z" fill="#d4a842"/></svg>'), badge: 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><path d="M46 34.4A16 16 0 1 1 29.6 18 12.7 12.7 0 0 0 46 34.4z" fill="#d4a842"/></svg>') });
  }
}

function scheduleBackgroundNotif(task) {
  // Use SW postMessage to schedule if SW available
  if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
    const msUntil = new Date(task.deadline) - Date.now();
    const msWarning = msUntil - 5 * 60 * 1000; // 5 min before
    if (msWarning > 0) {
      setTimeout(() => {
        navigator.serviceWorker.controller && navigator.serviceWorker.controller.postMessage({
          type: 'SCHEDULE_NOTIF',
          title: `â° Due soon: ${task.title}`,
          body: '5 minutes remaining on your Ramadan goal!',
          delay: 0
        });
      }, msWarning);
    }
    if (msUntil > 0) {
      setTimeout(() => {
        navigator.serviceWorker.controller && navigator.serviceWorker.controller.postMessage({
          type: 'SCHEDULE_NOTIF',
          title: `ğŸŒ™ Due now: ${task.title}`,
          body: 'Time is up on your Ramadan goal!',
          delay: 0
        });
      }, msUntil);
    }
  }
}

function requestNotif() {
  if (!('Notification' in window)) { showToast('Notifications not supported'); return; }
  Notification.requestPermission().then(perm => {
    if (perm === 'granted') {
      document.getElementById('notif-btn').style.display = 'none';
      document.getElementById('notif-granted').style.display = 'block';
      showToast('ğŸ”” Reminders enabled!');
      sendNotification('Ramadan Goals ğŸŒ™', 'Notifications enabled! We\'ll remind you of your goals.');
    } else {
      showToast('Please allow notifications in browser settings');
    }
  });
}

function updateNotifUI() {
  const btn = document.getElementById('notif-btn');
  const granted = document.getElementById('notif-granted');
  if (Notification.permission === 'granted') {
    btn.style.display = 'none';
    granted.style.display = 'block';
  } else if (Notification.permission !== 'denied') {
    btn.style.display = 'inline-flex';
    granted.style.display = 'none';
  }
}

// â”€â”€â”€ PWA INSTALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredInstallPrompt = e;
  if (!localStorage.getItem('install-dismissed')) {
    const banner = document.getElementById('install-banner');
    banner.style.display = 'flex';
  }
});

function installPWA() {
  if (deferredInstallPrompt) {
    deferredInstallPrompt.prompt();
    deferredInstallPrompt.userChoice.then(choice => {
      if (choice.outcome === 'accepted') showToast('ğŸ“² App installed!');
      deferredInstallPrompt = null;
      document.getElementById('install-banner').style.display = 'none';
    });
  }
}

function dismissInstall() {
  document.getElementById('install-banner').style.display = 'none';
  localStorage.setItem('install-dismissed', '1');
}

window.addEventListener('appinstalled', () => {
  document.getElementById('install-banner').style.display = 'none';
  showToast('ğŸ“² Ramadan Goals installed!');
});

// â”€â”€â”€ SERVICE WORKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function registerServiceWorker() {
  if (!('serviceWorker' in navigator)) return;

  const swCode = `
    const CACHE = 'ramadan-goals-v1';
    self.addEventListener('install', e => {
      self.skipWaiting();
    });
    self.addEventListener('activate', e => {
      e.waitUntil(clients.claim());
    });
    self.addEventListener('fetch', e => {
      // Cache-first for same-origin
      if (e.request.url.startsWith(self.location.origin)) {
        e.respondWith(
          caches.open(CACHE).then(cache =>
            cache.match(e.request).then(cached => {
              const fetch_promise = fetch(e.request).then(response => {
                cache.put(e.request, response.clone());
                return response;
              }).catch(() => cached);
              return cached || fetch_promise;
            })
          )
        );
      }
    });
    self.addEventListener('message', e => {
      if (e.data && e.data.type === 'SCHEDULE_NOTIF') {
        const { title, body, delay } = e.data;
        setTimeout(() => {
          self.registration.showNotification(title, {
            body,
            icon: 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 192"><rect width="192" height="192" rx="40" fill="#0d1b2a"/><path d="M140 96.79A49 49 0 1 1 91.21 48 38.1 38.1 0 0 0 140 96.79z" fill="#d4a842"/></svg>'),
            badge: 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 96 96"><path d="M70 48.4A24.5 24.5 0 1 1 45.6 24 19 19 0 0 0 70 48.4z" fill="#d4a842"/></svg>'),
            vibrate: [200, 100, 200],
            tag: title,
            requireInteraction: true,
          });
        }, delay || 0);
      }
    });
    self.addEventListener('notificationclick', e => {
      e.notification.close();
      e.waitUntil(clients.openWindow('/'));
    });
    self.addEventListener('push', e => {
      const data = e.data ? e.data.json() : { title: 'Ramadan Goals', body: 'Check your goals!' };
      e.waitUntil(self.registration.showNotification(data.title, { body: data.body }));
    });
  `;

  const blob = new Blob([swCode], { type: 'application/javascript' });
  const swUrl = URL.createObjectURL(blob);

  navigator.serviceWorker.register(swUrl, { scope: '/' })
    .then(reg => {
      console.log('SW registered');
      // Re-schedule notifs for existing tasks with future deadlines
      tasks.forEach(task => {
        if (task.deadline && !task.done && new Date(task.deadline) > new Date()) {
          scheduleBackgroundNotif(task);
        }
      });
    })
    .catch(err => console.warn('SW registration failed (may need HTTPS):', err));
}

// â”€â”€â”€ MANIFEST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function injectManifest() {
  const manifest = {
    name: 'Ramadan Goals',
    short_name: 'Ramadan',
    description: 'Track your Ramadan goals with friends',
    start_url: './',
    display: 'standalone',
    background_color: '#0d1b2a',
    theme_color: '#0d1b2a',
    orientation: 'portrait',
    icons: [
      { src: "data:image/svg+xml," + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 192"><rect width="192" height="192" rx="40" fill="#0d1b2a"/><path d="M140 96.79A49 49 0 1 1 91.21 48 38.1 38.1 0 0 0 140 96.79z" fill="#d4a842"/></svg>'), sizes: "192x192", type: "image/svg+xml" },
      { src: "data:image/svg+xml," + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" rx="100" fill="#0d1b2a"/><path d="M374 262A130 130 0 1 1 244 132a101 101 0 0 0 130 130z" fill="#d4a842"/></svg>'), sizes: "512x512", type: "image/svg+xml" }
    ]
  };
  const blob = new Blob([JSON.stringify(manifest)], { type: 'application/manifest+json' });
  document.querySelector('link[rel="manifest"]').href = URL.createObjectURL(blob);
}

// â”€â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

let toastTimer;
function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2500);
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init() {
  initStars();
  load();
  updateDayLabel();
  checkDailyReset();
  updateNotifUI();
  injectManifest();
  renderTabs();
  renderTasks();
  registerServiceWorker();
  setInterval(checkDailyReset, 60000);
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
